<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scribbly — Save Your Notes</title>
  <meta name="description" content="Scribbly: write, save, and delete notes with localStorage. Online note website application" />
  <meta name="theme-color" content="#CC1A7D" />
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="icon.png">
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="manifest" href="manifest.json?v=2" />
  <!-- Install & Debug buttons -->
  <button id="installBtn" style="position:fixed;top:8px;right:8px;padding:6px 10px;background:#CC1A7D;color:#fff;border:none;border-radius:4px;font-size:14px;cursor:pointer;display:none;">Install Scribbly</button>
  <button id="checkSwBtn" style="position:fixed;top:8px;right:120px;padding:6px 10px;background:#444;color:#fff;border:none;border-radius:4px;font-size:14px;cursor:pointer;">Check SW</button>
  <script>
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');
    const checkSwBtn = document.getElementById('checkSwBtn');

    async function registerSW() {
      if ('serviceWorker' in navigator) {
        try {
          const reg = await navigator.serviceWorker.register('./service-worker.js',{scope:'./'});
          await reg.update();
          console.log('[SW] registered & updated');
        } catch (e) { console.error('[SW] reg error',e); }
      }
    }
    registerSW();

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      console.log('[PWA] beforeinstallprompt captured – prompt ready');
      installBtn.style.display = 'block';
    });

    // Fallback: if Chrome never fires the event, still show button after first interaction
    let interactionDone = false;
    function tryShowInstall() {
      if (interactionDone) return;
      interactionDone = true;
      if (!deferredPrompt) {
        console.warn('[PWA] Chrome did not fire beforeinstallprompt; faking it');
        installBtn.style.display = 'block';
      }
    }
    window.addEventListener('click', tryShowInstall, { once: true });
    window.addEventListener('input', tryShowInstall, { once: true });
    installBtn.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') installBtn.style.display = 'none';
        deferredPrompt = null;
      }
    });
    checkSwBtn.addEventListener('click', () => {
      registerSW();
      location.reload();           // refresh audit
    });
  </script>
  <!-- DEBUG: live audit panel -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const panel = document.createElement('div');
      panel.id = 'pwa-audit';
      panel.style.cssText = 'position:fixed;bottom:4px;left:4px;background:#0009;color:#0f0;padding:4px 6px;font:11px/1.2 monospace;z-index:9999;white-space:pre;';
      document.body.appendChild(panel);
      function tick() {
        const ok = (s) => s ? '✅' : '❌';
        const sw = navigator.serviceWorker.controller;
        const https = location.protocol === 'https:' || location.hostname === 'localhost';
        fetch('manifest.json?v=' + Date.now())
          .then(r => r.json())
          .then(m => {
            const icons = m.icons.map(i => i.src).join(', ');
            const standalone = m.display === 'standalone';
            panel.textContent =
              `Secure context: ${ok(https)}\n` +
              `Manifest link: ${ok(true)}\n` +
              `Display standalone: ${ok(standalone)}\n` +
              `Icon link(s): ${icons}\n` +
              `Service worker active: ${ok(!!sw)}\n` +
              `beforeinstallprompt fired: ${ok(window._biPromptFired)}`;
          })
          .catch(() => panel.textContent = 'Manifest 404/invalid');
      }
      window._biPromptFired = false;
      window.addEventListener('beforeinstallprompt', () => { window._biPromptFired = true; tick(); });
      tick();
      setInterval(tick, 1000);
    });
  </script>
  <script>
    // Audit manifest & icons
    window.addEventListener('load', () => {
      fetch('manifest.json')
        .then(r => r.json())
        .then(j => console.log('[PWA] manifest JSON:', JSON.stringify(j, null, 2)))
        .catch(e => console.error('[PWA] manifest 404 or invalid JSON', e));

      // Check actual icon.png size
    const img = new Image();
    img.onload = () => console.log(`[PWA] icon.png natural size: ${img.naturalWidth}×${img.naturalHeight}`);
    img.src = 'icon.png?' + Date.now();

    // Live audit: always re-fetch manifest and list actual icons
    (async () => {
      try {
        const res = await fetch('manifest.json?v=' + Date.now());
        const json = await res.json();
        console.log('[PWA] live manifest:', JSON.stringify(json, null, 2));
        const icons = json.icons.map(i => i.src).join(', ');
        console.log('[PWA] manifest icons listed:', icons);
        // Wipe any cached icon list the panel might use
        localStorage.removeItem('scribbly-debug-icons');
        localStorage.removeItem('scribbly-debug-cache');
      } catch (e) {
        console.error('[PWA] manifest 404 or invalid', e);
      }
    })();
    });
  </script>
</head>  <!-- DEBUG: inline manifest to verify content -->
  <script type="application/json" id="manifestDebug">
    {"display":"standalone","start_url":"./","scope":"./","icons":[{"src":"icon.png","sizes":"192x192","type":"image/png"},{"src":"icon.png","sizes":"512x512","type":"image/png","purpose":"maskable"}]}
  </script>
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <span class="logo" aria-hidden="true">✏️</span>
      <h1>Scribbly</h1>
    </div>
    <div class="header-actions">
      <button id="newNoteBtn" class="btn">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 5v14"></path>
            <path d="M5 12h14"></path>
          </svg>
        </span>
        <span class="label">New Note</span>
      </button>
      <button id="installBtn" class="btn" hidden>
        <span class="label">Install App</span>
      </button>
    </div>
  </header>

  <main class="app">
    <aside class="sidebar">
      <div class="search">
        <input id="searchInput" type="text" placeholder="Search notes…" aria-label="Search notes" />
      </div>
      <ul id="notesList" class="notes-list" aria-label="Notes list"></ul>
    </aside>

    <section class="editor" aria-label="Note editor">
      <input id="noteTitle" type="text" placeholder="Title" aria-label="Note title" />
      <textarea id="noteContent" placeholder="Write your note here…" aria-label="Note content"></textarea>
      <div class="editor-toolbar">
        <button id="infoBtn" class="btn" type="button" aria-label="About & Help">
          <span class="icon" aria-hidden="true">!</span>
        </button>
        <span id="status" class="status" role="status" aria-live="polite"></span>
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <small>Works offline. Installable. Your notes stay on this device.</small>
  </footer>

  <div id="contextMenu" class="context-menu" hidden>
    <button id="contextPin" class="item" type="button">Pin/Unpin</button>
    <button id="contextDelete" class="item danger" type="button">Delete</button>
  </div>
  <!-- Hidden button for manual date/time editing; not visible but clickable via status text -->
  <button id="editDateBtn" type="button" hidden aria-hidden="true"></button>

  <!-- About / Help Modal -->
  <div id="aboutModal" class="modal-overlay" hidden role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
    <div class="modal">
      <div class="modal-header">
        <h2 id="aboutTitle">About Scribbly</h2>
        <button id="aboutClose" class="modal-close" type="button" aria-label="Close">×</button>
      </div>
      <div class="modal-body">
        <p>Scribbly is a simple lightweight notes app that works even when you’re offline.</p>
        <p>Your notes are saved on this device. No account, no cloud.</p>
        <p>Tips:</p>
        <ul>
          <li>Click <strong>New Note</strong> to start writing.</li>
          <li>Select a note to open it; changes save automatically.</li>
          <li>Use the <strong>search</strong> box to filter notes by title or content.</li>
          <li>Right‑click a note to <strong>Pin</strong> or <strong>Delete</strong>.</li>
          <li><strong>Install:</strong> Click <em>Install App</em> (when shown) or use your browser’s “Install”, “Add to Home Screen”.</li>
          <li><strong>Offline:</strong> The app works without internet. The header shows your status.</li>
        </ul>
        <p>If you clear your browser’s site data, your notes will be removed.</p>
      </div>
    </div>
  </div>
  <script src="script.js"></script>

</body>
</html>